---
- name: install squid with ssl support
  import_tasks: install.yml
  tags: srv_squid_install


- name: setup squid ssl certificate
  import_tasks: ssl.yml
  when: squid_ssl_enable |bool
  tags: srv_squid_ssl

- name: add local upstream peers to /etc/hosts
  lineinfile:
    path: /etc/hosts
    line: "127.0.0.1\t{{ item.host }}"
    state: present
    # docker does not allow atomic updates of /etc/hosts
    # see https://github.com/ansible/ansible/issues/13981
    # see https://docs.docker.com/network/bridge/#differences-between-user-defined-bridges-and-the-default-bridge
    unsafe_writes: "{{ ansible_virtualization_type == 'docker' }}"
  loop: "{{ squid_domain_rules
          | json_query('[?!!localhost]')
          | list }}"
  loop_control:
    label: "{{ item.host }}"
  tags: srv_squid_config


- name: configure squid
  import_tasks: config.yml
  tags: srv_squid_config

- name: url-rewrite for squid
  import_tasks: url-rewrite.yml
  when: squid_url_rewrite |length > 0
  tags: srv_squid_config


- name: setup ufw firewall for squid
  import_tasks: firewall-ufw.yml
  tags: srv_squid_firewall
  when: lin_firewall == 'ufw'

- name: setup ferm firewall for squid
  import_tasks: firewall-ferm.yml
  tags: srv_squid_firewall
  when: lin_firewall == 'ferm'

- name: transparent iptables rules for squid
  import_tasks: iptables.yml
  tags: srv_squid_iptables
  when: lin_firewall in ['ufw', 'ferm']


- name: stop obsolete squid service (ok to fail, if not found)
  systemd:
    name: squid
    state: stopped
    enabled: false
    daemon_reload: true
  when: squid_pkg == 'squid-ssl'
        and squid_ssl_ppa is defined
        and squid_ssl_ppa is changed
  ignore_errors: true
  tags: srv_squid_service

- name: activate squid-ssl service
  systemd:
    name: "{{ squid_pkg }}"
    state: started
    enabled: true
    daemon_reload: true
  tags: srv_squid_service


- name: directory for distributed pac files
  file:
    path: "{{ squid_etc_dir }}/pac"
    state: directory
    owner: root
    group: "{{ web_group }}"
    mode: 0750
  when: web_group is defined
  tags: srv_squid_pac

- name: generate pac files
  template:
    src: squid.pac.j2
    dest: "{{ squid_etc_dir }}/pac/{{ item.name }}.pac"
    owner: root
    group: "{{ web_group }}"
    mode: 0640
  loop: "{{ squid_pac.pac_types }}"
  loop_control:
    label: "{{ item.name }}"
  when: web_group is defined
  tags: srv_squid_pac


- name: enable/disable compression of squid logs
  replace:
    path: /etc/logrotate.d/squid-ssl
    regexp: "{{ lookbehind }}(compress|delaycompress)"
    replace: "{{ commentout }}\\1"
  vars:
    lookbehind: "{{ lin_compress_logs |bool |ternary('(?:#\\s*)','(?<!#)') }}"
    commentout: "{{ lin_compress_logs |bool |ternary('','#') }}"
  when: lin_compress_logs is not none
  tags: srv_squid_logs
...
